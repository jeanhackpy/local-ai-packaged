# OpenClaw & Caddy Configuration Guide

Complete guide for configuring OpenClaw (AI agent gateway) and Caddy (reverse proxy) for your local-ai-packaged deployment.

## Table of Contents

- [OpenClaw Overview](#openclaw-overview)
- [Current Setup](#current-setup)
- [OpenClaw Gateway Configuration](#openclaw-gateway-configuration)
- [Caddy Configuration](#caddy-configuration)
- [Production Domain Setup](#production-domain-setup)
- [Testing Configuration](#testing-configuration)
- [Onboarding Skills & Telegram](#onboarding-skills--telegram)
- [Troubleshooting](#troubleshooting)

---

## OpenClaw Overview

**OpenClaw** is an AI agent platform that can execute code, use tools, and integrate with various services. It runs as a containerized gateway that you can access via web UI or integrate with other services.

### Key Features
- **Docker-based deployment** - Runs in a container with isolated environment
- **Token authentication** - Secure access via gateway tokens
- **Skills system** - Extend capabilities with custom skills
- **Telegram integration** - Control agents via Telegram bot
- **Tool execution** - Run code, access files, use Docker tools

### Current Version
- **Installed**: `ghcr.io/openclaw/openclaw:2026.2.2`
- **Latest**: `ghcr.io/openclaw/openclaw:2026.2.4`
- **Update recommended**: Minor version update available

---

## Current Setup

### Container Configuration

From `docker-compose.yml`:

```yaml
openclaw:
  image: ghcr.io/openclaw/openclaw:2026.2.2
  container_name: openclaw
  restart: unless-stopped
  init: true
  ports:
    - 18789:18789/tcp  # Web UI / Gateway
    - 18790:18790/tcp  # Additional port
  environment:
    - HOME=/home/node
    - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
    - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
    - SERPER_API_KEY=${SERPER_API_KEY}
    - NODE_OPTIONS=--max-old-space-size=768
    - PIP_CACHE_DIR=/home/node/tools/.cache
    - PYTHONUSERBASE=/home/node/tools/python
  volumes:
    - ./openclaw:/home/node/.openclaw
    - openclaw-tools:/home/node/tools
    - /var/run/docker.sock:/var/run/docker.sock
  deploy:
    resources:
      limits:
        memory: 2G
```

### Environment Variables

Required in `.env`:

```bash
# OpenClaw Gateway Token (auto-generated if not set)
OPENCLAW_GATEWAY_TOKEN=your-64-character-hex-token

# Optional: OpenRouter API for cloud models
OPENROUTER_API_KEY=your-openrouter-key

# Optional: Serper API for web search
SERPER_API_KEY=your-serper-key
```

---

## OpenClaw Gateway Configuration

### Accessing the Gateway

#### Local Access
```
http://localhost:18789
```

#### VPS Access
```
http://YOUR_VPS_IP:18789
```

#### With Your VPS IP (example)
```
http://37.YOUR_VPS_IP:18789
```

### Gateway Token Setup

The gateway token is automatically generated by `start_services.py` if not present in `.env`.

#### View Your Token

```bash
# Check your .env file
grep OPENCLAW_GATEWAY_TOKEN /home/phil/local-ai-packaged/.env

# Or generate a new one manually
openssl rand -hex 32
```

#### Get Dashboard URL with Token

```bash
cd /home/phil/local-ai-packaged

# Get the tokenized URL
docker compose run --rm openclaw openclaw dashboard --no-open
```

This will output something like:
```
http://127.0.0.1:18789/?token=your-gateway-token-here
```

### First-Time Setup

1. **Start the service**:
   ```bash
   python3 start_services.py --profile gpu-nvidia --environment public
   ```

2. **Access the dashboard**:
   ```bash
   # Get the URL with token
   docker compose run --rm openclaw openclaw dashboard --no-open
   ```

3. **Open in browser**:
   - Copy the URL from step 2
   - Open in your browser
   - The token will be automatically applied

4. **Save the token** in the Control UI:
   - Go to Settings → Token
   - Paste your `OPENCLAW_GATEWAY_TOKEN`
   - Save

---

## Caddy Configuration

### Current Caddyfile

Located at `/home/phil/local-ai-packaged/Caddyfile`:

```caddyfile
{
  # Global options
  acme_ca https://acme-v02.api.letsencrypt.org/directory
  email {$LETSENCRYPT_EMAIL}
  import /etc/caddy/addons/*.conf
}

# N8N - Production subdomain
{$N8N_HOSTNAME} {
  reverse_proxy n8n:5678
}

# Open WebUI - Production subdomain
{$WEBUI_HOSTNAME} {
  reverse_proxy open-webui:8080
}

# OpenClaw - COMMENTED OUT (use localhost:18789)
# {$OPENCLAW_HOSTNAME} {
#   reverse_proxy openclaw:18789
# }

# Supabase - COMMENTED OUT (use localhost:8000)
# {$SUPABASE_HOSTNAME} {
#   reverse_proxy kong:8000
# }

# Neo4j - COMMENTED OUT (use localhost:7474)
# {$NEO4J_HOSTNAME} {
#   reverse_proxy neo4j:7474
# }
```

### Production Configuration

Your `.env` should have:

```bash
############
# Caddy Config - Production Domains
############

# Public services (with SSL)
N8N_HOSTNAME=n8n.recall-agency.com
WEBUI_HOSTNAME=openwebui.recall-agency.com

# Email for Let's Encrypt
LETSENCRYPT_EMAIL=your-email@example.com

# Local services (commented out - use localhost)
# SUPABASE_HOSTNAME=:8005
# NEO4J_HOSTNAME=:8008
# OPENCLAW_HOSTNAME=:18789
```

### Service Access Summary

| Service | Access Method | URL |
|---------|--------------|-----|
| **n8n** | Public subdomain | https://n8n.recall-agency.com |
| **OpenWebUI** | Public subdomain | https://openwebui.recall-agency.com |
| **Supabase** | Localhost + port | http://YOUR_VPS_IP:8000 |
| **Qdrant** | Localhost + port | http://YOUR_VPS_IP:6333 |
| **Neo4j** | Localhost + port | http://YOUR_VPS_IP:7474 |
| **OpenClaw** | Localhost + port | http://YOUR_VPS_IP:18789 |

---

## Production Domain Setup

### DNS Configuration

For your subdomains to work, you need A records pointing to your VPS IP:

```
n8n.recall-agency.com        → YOUR_VPS_IP
openwebui.recall-agency.com  → YOUR_VPS_IP
```

### Firewall Configuration

```bash
# Allow HTTP and HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Verify firewall status
sudo ufw status
```

### Testing SSL Certificates

After starting services, Caddy will automatically obtain SSL certificates from Let's Encrypt.

```bash
# Check Caddy logs
docker logs caddy

# You should see messages like:
# "certificate obtained successfully"
```

### Enabling Additional Services in Caddy

If you want to expose OpenClaw via subdomain (not recommended for security), edit `Caddyfile`:

```caddyfile
# Uncomment and configure
{$OPENCLAW_HOSTNAME} {
  reverse_proxy openclaw:18789
  
  # Optional: Add basic auth
  basicauth {
    username $2a$14$hashed_password_here
  }
}
```

Then add to `.env`:
```bash
OPENCLAW_HOSTNAME=openclaw.recall-agency.com
```

And restart:
```bash
docker restart caddy
```

---

## Testing Configuration

### Test Caddy Configuration

```bash
# Check Caddyfile syntax
docker exec caddy caddy validate --config /etc/caddy/Caddyfile

# Reload Caddy without downtime
docker exec caddy caddy reload --config /etc/caddy/Caddyfile
```

### Test Service Accessibility

```bash
# Test n8n locally
curl -I http://localhost:5678

# Test n8n via Caddy (if running locally)
curl -I http://localhost:8001

# Test from outside (replace with your domain)
curl -I https://n8n.recall-agency.com
```

### Test OpenClaw Gateway

```bash
# Test local access
curl http://localhost:18789

# Test with token (replace TOKEN)
curl http://localhost:18789/?token=YOUR_TOKEN

# Check if container is running
docker ps | grep openclaw

# Check logs
docker logs openclaw
```

---

## Onboarding Skills & Telegram

### Official Documentation

Follow the official OpenClaw Docker guide:
https://docs.openclaw.ai/install/docker

### Onboarding Wizard

Run the onboarding wizard to configure skills and integrations:

```bash
cd /home/phil/local-ai-packaged

# Run onboarding
docker compose run --rm openclaw openclaw onboard
```

This will guide you through:
1. **Provider setup** (OpenAI, Anthropic, OpenRouter, etc.)
2. **Skill installation** (web search, code execution, etc.)
3. **Channel setup** (Telegram, Slack, Discord)

### Telegram Integration

#### Step 1: Create Telegram Bot

1. Open Telegram and search for `@BotFather`
2. Send `/newbot`
3. Follow prompts to create your bot
4. Save the **bot token**

#### Step 2: Configure OpenClaw

```bash
# Run onboarding and select Telegram
docker compose run --rm openclaw openclaw onboard

# Or configure manually
docker compose run --rm openclaw openclaw channels add telegram
```

#### Step 3: Add Token

When prompted, enter your Telegram bot token.

#### Step 4: Start the Bot

```bash
# Restart OpenClaw
docker restart openclaw

# Check logs to verify Telegram connection
docker logs openclaw | grep -i telegram
```

### Installing Skills

```bash
# List available skills
docker compose run --rm openclaw openclaw skills list

# Install a skill
docker compose run --rm openclaw openclaw skills install SKILL_NAME

# Example: Install web search
docker compose run --rm openclaw openclaw skills install web-search
```

### Managing Devices

```bash
# List paired devices
docker compose run --rm openclaw openclaw devices list

# Approve a device pairing request
docker compose run --rm openclaw openclaw devices approve REQUEST_ID

# Remove a device
docker compose run --rm openclaw openclaw devices remove DEVICE_ID
```

---

## Troubleshooting

### OpenClaw Won't Start

```bash
# Check logs
docker logs openclaw

# Common issues:
# 1. Port already in use
sudo netstat -tulpn | grep 18789

# 2. Permission issues with Docker socket
ls -l /var/run/docker.sock

# 3. Memory limit reached
docker stats openclaw
```

### Can't Access Gateway

```bash
# Check if container is running
docker ps | grep openclaw

# Check if port is exposed
docker port openclaw

# Test local access
curl http://localhost:18789

# Check firewall
sudo ufw status | grep 18789
```

### Token Authentication Fails

```bash
# Verify token in .env
grep OPENCLAW_GATEWAY_TOKEN .env

# Generate new token
openssl rand -hex 32

# Update .env with new token
nano .env

# Restart OpenClaw
docker restart openclaw
```

### Caddy SSL Certificate Issues

```bash
# Check Caddy logs
docker logs caddy

# Verify DNS records
dig n8n.recall-agency.com

# Test Let's Encrypt connectivity
docker exec caddy caddy validate --config /etc/caddy/Caddyfile

# Force certificate renewal
docker exec caddy caddy reload --config /etc/caddy/Caddyfile
```

### Telegram Bot Not Responding

```bash
# Check OpenClaw logs
docker logs openclaw | grep -i telegram

# Verify bot token
docker compose run --rm openclaw openclaw channels list

# Restart OpenClaw
docker restart openclaw

# Test bot manually
# Send /start to your bot in Telegram
```

---

## Updating OpenClaw

### Update to Latest Version

Edit `docker-compose.yml`:

```yaml
openclaw:
  image: ghcr.io/openclaw/openclaw:2026.2.4  # Update version
```

Then:

```bash
# Pull new image
docker compose pull openclaw

# Restart with new version
docker compose up -d openclaw

# Verify version
docker logs openclaw | head -20
```

---

## Quick Reference

### OpenClaw Commands

```bash
# Get dashboard URL
docker compose run --rm openclaw openclaw dashboard --no-open

# Run onboarding
docker compose run --rm openclaw openclaw onboard

# List devices
docker compose run --rm openclaw openclaw devices list

# List skills
docker compose run --rm openclaw openclaw skills list

# View logs
docker logs -f openclaw
```

### Caddy Commands

```bash
# Validate config
docker exec caddy caddy validate --config /etc/caddy/Caddyfile

# Reload config
docker exec caddy caddy reload --config /etc/caddy/Caddyfile

# View logs
docker logs -f caddy

# Test certificate
docker exec caddy caddy list-certificates
```

---

## Security Recommendations

> [!WARNING]
> **Do not expose OpenClaw publicly without authentication!**
> - Keep OpenClaw on localhost:18789 or use VPN
> - If you must expose it, use Caddy with basic auth
> - Rotate gateway tokens regularly

> [!IMPORTANT]
> **Protect your gateway token**:
> - Never commit `.env` to Git
> - Use strong, random tokens (64+ characters)
> - Rotate tokens if compromised

> [!TIP]
> **Best practices**:
> - Only expose n8n and OpenWebUI via subdomains
> - Access other services via SSH tunnel or VPN
> - Keep Docker socket access restricted
> - Monitor OpenClaw logs for suspicious activity
